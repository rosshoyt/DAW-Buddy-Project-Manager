<!DOCTYPE html>
<html lang="en">

<head>
  <title>DAW Buddy</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="./styles.css" type="text/css">
</head>

<body>
  <nav>
    <div class="nav-wrapper deep-purple">
      <a class="brand-logo right">DAW Buddy</a>
    </div>
  </nav>

  <body>

    <a class="waves-effect waves-light btn-large light-blue lighten-1" onclick="clickButton()">
      <!--i class="material-icons left">home</i-->Add Search Folder</a>
    <script>
      const { ipcRenderer } = require('electron');

      function clickButton() {
        const { dialog } = require('electron').remote;
        const ul = document.querySelector('ul');

        dialog.showOpenDialog({
          properties: ['openDirectory']
        }).then(result => {
          //console.log(result.canceled);
          //console.log(result.filePaths);

          ul.className = 'collection';
          const li = document.createElement('li');
          li.className = 'collection-item';
          const itemText = document.createTextNode(result.filePaths);
          li.appendChild(itemText);
          ul.appendChild(li);
          // get the label element
          var label = document.getElementById("folderslistlabel");

          // Update UI based on number of list elements in directory list:
          var x = document.getElementById("folderslist").childElementCount;
          var listLabelText = '';
          var listLabelPositionClass = 'left';
          //var toggleStartButtonDisabled = false; // TODO refactor startButton toggling code
          var startButton = document.querySelector("#startscanbtn");
          // update text and position of info label, and enable/disable start button
          if (x == 0) {
            label.innerText = 'Add a search folder to get started';
            label.classList.remove('left');
            label.classList.add('right');
            if (!startButton.classList.contains('disabled')) {
              startButton.classList.add('disabled');
            }
          } else {
            label.innerText = 'Folder(s) to Search:';
            label.classList.remove('right');
            label.classList.add('left');
            if (startButton.classList.contains('disabled')) {
              startButton.classList.remove('disabled');

            }
          }

        }).catch(err => {
          console.log(err);
        });

      }
    </script>
    <a class="waves-effect waves-light btn-large right green accent-3 disabled" id="startscanbtn"
      onclick="clickStart()">Start Scan</a>
    <script>
      function clickStart() {
        let folders = document.getElementById("folderslist").querySelectorAll('li');
        if (folders.length > 0) {
          var folderPaths = [];
          // convert each collection item into a string path
          folders.forEach((item, index) => {
            folderPaths.push(item.innerText);
          });
          // send directory paths to main thread
          ipcRenderer.send('startscan', folderPaths);
        }
      }
    </script>
    <div>
      <label id="folderslistlabel" class="right"><--Add a search folder to get started</label>
    </div>
    <div class="section">
      <!--a class="waves-effect waves-light btn-large right disabled" id="startscanbtn" onclick="clickStart()">Start Scan</a-->
      <ul id="folderslist"></ul>
      <script>
        const ul = document.querySelector('ul');

        // Clear items
        ipcRenderer.on('item:clear', function () {
          ul.innerHTML = '';
          ul.className = '';
        });

        // Remove item
        ul.addEventListener('dblclick', removeItem);

        function removeItem(e) {
          e.target.remove();
          if (ul.children.length == 0) {
            ul.className = '';
          }
        }
      </script>
    </div>
    <!--label id="projectslistlabel"></label-->
    <div class="container">
      <table id="projectsTable" class="striped">
        <thead>
          <tr>
            <th>Project Name</th>
            <th>Date Created</th>
            <th>DAW Type</th>
            <th>Total Size</th>
            <!--th></th-->
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <script>
      // fill table with single DAW project
      ipcRenderer.on('scan:complete:singleentry', function (e, project) {
        //const table = document.getElementById('projectsTable');
        createRow(project);
      });

      // fill table with DAW projects entries
      ipcRenderer.on('scan:complete', function (e, projects) {
        //const table = document.getElementById('projectsTable');
        projects.forEach(function (project) {
          createRow(project);
        });
      });

      function getReadableFileSizeString(fileSizeInBytes) {
        var i = -1;
        var byteUnits = [' kB', ' MB', ' GB', ' TB', 'PB', 'EB', 'ZB', 'YB'];
        do {
          fileSizeInBytes = fileSizeInBytes / 1024;
          i++;
        } while (fileSizeInBytes > 1024);

        return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
      };

      function createRow(project) {
        // TODO pass tableRef into method?
        var tableRef = document.getElementById('projectsTable').getElementsByTagName('tbody')[0];

        // Insert a row at the end of the table
        var newRow = tableRef.insertRow(-1);
        newRow.id = project.dir.fullPath;
        //newRow.addEventListener('click', selectRow); // TODO
        newRow.addEventListener('dblclick', openRowDetailWindow);


        // Append a text node to the cell
        var projectName = document.createTextNode(project.projectName);
        var dateCreated = document.createTextNode(project.dir.timeCreated);
        var dawType = document.createTextNode(project.dawType);
        var sizeBytes = document.createTextNode(getReadableFileSizeString(project.totalBytes));
        //var numProjFiles = document.createTextNode(project.dawFiles.length);
      


        // Insert a cell in the row at index 0
        var cell1 = newRow.insertCell(0);
        var cell2 = newRow.insertCell(1);
        var cell3 = newRow.insertCell(2);
        var cell4 = newRow.insertCell(3);

        cell1.appendChild(projectName);
        cell2.appendChild(dateCreated);
        cell3.appendChild(dawType);
        //cell3.appendChild(numProjFiles);
        cell4.appendChild(sizeBytes);

      }

      function openRowDetailWindow(r) {
        var id = r.target.parentNode.id;
        console.log('Opening Row-Detail Window for project path ', id);//r.target.id);
        ipcRenderer.send('getprojectdetail', id);
      }
    </script>
  </body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
  <title>DAW Buddy</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="./styles.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
  <nav>
    <div class="nav-wrapper deep-purple">
      <a class="brand-logo right">DAW Buddy</a>
    </div>
  </nav>



  <a class="waves-effect waves-light btn-large light-blue lighten-1" onclick="clickButton()">
    <!--i class="material-icons left">home</i-->Add Search Folder</a>
  <script>
    const { ipcRenderer } = require('electron');

    // function initSessionStorage(){
    //   console.log('initializing session storage');
    //   sessionStorage.projectsMap = new Map();
    // }

    function clickButton() {
      const { dialog } = require('electron').remote;
      const ul = document.querySelector('ul');

      dialog.showOpenDialog({
        properties: ['openDirectory']
      }).then(result => {
        //console.log(result.canceled);
        //console.log(result.filePaths);

        ul.className = 'collection';
        const li = document.createElement('li');
        li.className = 'collection-item';
        const itemText = document.createTextNode(result.filePaths);
        li.appendChild(itemText);
        ul.appendChild(li);
        // get the label element
        var label = document.getElementById("folderslistlabel");

        // Update UI based on number of list elements in directory list:
        var x = document.getElementById("folderslist").childElementCount;
        var listLabelText = '';
        var listLabelPositionClass = 'left';
        //var toggleStartButtonDisabled = false; // TODO refactor startButton toggling code
        var startButton = document.querySelector("#startscanbtn");
        // update text and position of info label, and enable/disable start button
        if (x == 0) {
          label.innerText = 'Add a search folder to get started';
          label.classList.remove('left');
          label.classList.add('right');
          if (!startButton.classList.contains('disabled')) {
            startButton.classList.add('disabled');
          }
        } else {
          label.innerText = 'Folder(s) to Search:';
          label.classList.remove('right');
          label.classList.add('left');
          if (startButton.classList.contains('disabled')) {
            startButton.classList.remove('disabled');

          }
        }

      }).catch(err => {
        console.log(err);
      });

    }
  </script>
  <a class="waves-effect waves-light btn-large right green accent-3 disabled" id="startscanbtn"
    onclick="clickStart()">Start Scan</a>
  <script>
    function clickStart() {
      let folders = document.getElementById("folderslist").querySelectorAll('li');
      if (folders.length > 0) {
        var folderPaths = [];
        // convert each collection item into a string path
        folders.forEach((item, index) => {
          folderPaths.push(item.innerText);
        });
        // send directory paths to main thread
        ipcRenderer.send('startscan', folderPaths);
      }
    }
  </script>
  <div>
    <label id="folderslistlabel" class="right">
      <--Add a search folder to get started</label>
  </div>
  <div class="section">
    <!--a class="waves-effect waves-light btn-large right disabled" id="startscanbtn" onclick="clickStart()">Start Scan</a-->
    <ul id="folderslist"></ul>
    <script>
      const ul = document.querySelector('ul');

      // Clear items
      ipcRenderer.on('item:clear', function () {
        ul.innerHTML = '';
        ul.className = '';
      });

      // Remove item
      ul.addEventListener('dblclick', removeItem);

      function removeItem(e) {
        e.target.remove();
        if (ul.children.length == 0) {
          ul.className = '';
        }
      }
    </script>
  </div>
  <!--label id="projectslistlabel"></label-->
  <div class="container deep-blue lighten-3">
    <h2>DAW Projects</h2>
    <table id="projectsTable" class="highlight">
      <thead>
        <tr>
          <th onclick="sortTableAlphanumerically(0)">Project Name</th>
          <th onclick="sortTableByTimeCreated(1)">Date Created</th>
          <th onclick="sortTableAlphanumerically(2)">DAW</th>
          <th onclick="sortTableBySize(3)">Size</th>
          <th onclick="sortTableByFavorite(4)">Favorite</th>
          <!--th></th-->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    // fill table with single DAW project
    ipcRenderer.on('scan:complete:singleentry', function (e, project) {
      sessionStorage.setItem(project.dir.fullPath, JSON.stringify(project));
      createRow(project);
    });

    ipcRenderer.on('scan:complete:allentries', function (e, projects) {
      projects.forEach(function (project) {
        sessionStorage.setItem(project.dir.fullPath, JSON.stringify(project));
        createRow(project);
      });
    });

    function sortTableAlphanumerically(colNum) {
      sortTable(colNum, "alpha");
    }
    function sortTableByTimeCreated(colNum) {
      sortTable(colNum, "timeCreated");
    }
    function sortTableBySize(colNum) {
      sortTable(colNum, "byteSize")
    }
    function sortTableByFavorite(colNum) {
      sortTable(colNum, "favorite");
    }

    function sortTable(colNum, sortType) {
      console.log('Sorting table by sort type: ', sortType);
      var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;

      var xRow, yRow, xProject, yProject;

      table = document.getElementById("projectsTable");
      switching = true;
      //Set the sorting direction to ascending:
      dir = "asc";
      /*Make a loop that will continue until
      no switching has been done:*/
      while (switching) {
        //start by saying: no switching is done:
        switching = false;
        rows = table.rows;
        /*Loop through all table rows (except the
        first, which contains table headers):*/
        for (i = 1; i < (rows.length - 1); i++) {
          //start by saying there should be no switching:
          shouldSwitch = false;
          /*Get the two elements you want to compare,
          one from current row and one from the next:*/
          xRow = rows[i], yRow = rows[i + 1];

          xProject = JSON.parse(sessionStorage.getItem(xRow.id)), yProject = JSON.parse(sessionStorage.getItem(yRow.id));
          //console.log('Comparing projects ', xProject.projectName, yProject.projectName);

          let xVal, yVal;
          switch (sortType) {
            case "byteSize":
              xVal = xProject.totalBytes;
              yVal = yProject.totalBytes;
              break;
            case "timeCreated":
              xVal = xProject.dir.timeCreated;
              yVal = yProject.dir.timeCreated;
              break;
            case "favorite":
              xVal = xProject.isFavorite;
              yVal = xProject.isFavorite;
            default:
              // lexographic, use contents of row's value in sort column 
              xVal = xRow.getElementsByTagName("TD")[colNum].innerHTML.toLowerCase();
              yVal = yRow.getElementsByTagName("TD")[colNum].innerHTML.toLowerCase();
              break;
          }
          /*check if the two rows should switch place,
          based on the direction, asc or desc:*/
          if (dir == "asc") {
            //console.log('comparing ', xVal, ' and ', yVal);
            if (xVal > yVal) {
              //if so, mark as a switch and break the loop:
              shouldSwitch = true;
              break;
            }
          } else if (dir == "desc") {
            if (xVal < yVal) {
              //if so, mark as a switch and break the loop:
              shouldSwitch = true;
              break;
            }
          }
          // break the for-loop if we need to switch row
        }
        if (shouldSwitch) {
          /*If a switch has been marked, make the switch
          and mark that a switch has been done:*/
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          //Each time a switch is done, increase this count by 1:
          switchcount++;
        } else {
          /*If no switching has been done AND the direction is "asc",
          set the direction to "desc" and run the while loop again.*/
          if (switchcount == 0 && dir == "asc") {
            dir = "desc";
            switching = true;
          }
        }
      }
    }

    function getReadableFileSizeString(fileSizeInBytes) {
      var i = -1;
      var byteUnits = [' kB', ' MB', ' GB', ' TB', 'PB', 'EB', 'ZB', 'YB'];
      do {
        fileSizeInBytes = fileSizeInBytes / 1024;
        i++;
      } while (fileSizeInBytes > 1024);
      return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
    };

    function createRow(project) {
      // TODO pass tableRef into method?
      var tableRef = document.getElementById('projectsTable').getElementsByTagName('tbody')[0];

      // Insert a row at the end of the table
      var newRow = tableRef.insertRow(-1);
      newRow.id = project.dir.fullPath;
      //newRow.addEventListener('click', selectRow); // TODO
      newRow.addEventListener('dblclick', openRowDetailWindow);

      // Append a text node to the cell
      var projectName = document.createTextNode(project.projectName);
      var dateCreated = document.createTextNode(project.dir.timeCreated);
      var dawType = document.createTextNode(project.dawType);
      var sizeBytes = document.createTextNode(getReadableFileSizeString(project.totalBytes));
      //var numProjFiles = document.createTextNode(project.dawFiles.length);
      var favoriteIcon = document.createTextNode(project.isFavorite ? "star" : "star_border");

      // create an element to hold the 'favorite' star icon
      var isFavorite = document.createElement("i"); //
      isFavorite.classList.add("material-icons");
      isFavorite.appendChild(favoriteIcon);
      isFavorite.addEventListener('click', toggleFavorite);
      //isFavorite.addEventListener('dblclick', function(){});

      // Insert a cell in the row at index 0
      var cell1 = newRow.insertCell(0);
      var cell2 = newRow.insertCell(1);
      var cell3 = newRow.insertCell(2);
      var cell4 = newRow.insertCell(3);
      var cell5 = newRow.insertCell(4);

      cell1.appendChild(projectName);
      cell2.appendChild(dateCreated);
      cell3.appendChild(dawType);
      //cell3.appendChild(numProjFiles);
      cell4.appendChild(sizeBytes);
      cell5.appendChild(isFavorite);
    }

    function openRowDetailWindow(e) {
      var parNode = e.target.parentNode;
      //console.log(parNode.nodeName);
      // Don't open detail window if user clicked on 'favorite icon' 
      if (parNode.nodeName === "TR") {
        //while(parNode.nodeName !== "TR")
        //  parNode = parNode.parentNode;
        var id = parNode.id;
        console.log('Opening Row-Detail Window for project path ', id);//r.target.id);
        ipcRenderer.send('getprojectdetail', id);
      }
    }

    function toggleFavorite(e) {

      console.log('target:', e.target);
      console.log('target parent:', e.target.parentNode);
      console.log('target child:', e.target.firstChild);

      var id = e.target.parentNode.parentNode.id;
      //console.log('user clicked favorite button, id =', id);
      // TODO don't use session storage, send message to IPC Main to get and update DB entry
      var project = JSON.parse(sessionStorage.getItem(id));
      //console.log(project);
      project.isFavorite = project.isFavorite ? false : true;
      //console.log(project.id, project.isFavorite);
      //console.log('project is now', project.isFavorite ? 'favorited':'un-favorited');

      
      //e.target.firstChild.remove;
      var textNode = document.createTextNode(project.isFavorite ? "star" : "star_border");
      
      console.log('removing target\'s child', e.target.firstChild);
      e.target.removeChild(e.target.firstChild);

      e.target.appendChild(textNode);
      // TODO update database entry instead of/in addition to session storage
      sessionStorage.setItem(id, JSON.stringify(project));
      //e.target.parentNode.appendChild()
      
    }
  </script>
</body>

</html>